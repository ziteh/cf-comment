<form id="comment-form">
  <input type="text" id="name" placeholder="Name (optional)" />
  <!-- <input type="email" id="email" placeholder="Email (optional)" /> -->
  <textarea id="message" required></textarea>
  <button type="submit">Send</button>
</form>

<pre id="preview"></pre>

<div id="comments"></div>

<script type="module">
  const API_URL = 'http://localhost:8787/api';
  const POST = '/blog/my-post';

  const form = document.getElementById('comment-form');
  const preview = document.getElementById('preview');
  const messageInput = document.getElementById('message');
  const commentsEl = document.getElementById('comments');

  const render = (md) => DOMPurify.sanitize(snarkdown(md));

  messageInput.addEventListener('input', () => {
    preview.innerHTML = render(messageInput.value);
  });

  async function loadComments() {
    const res = await fetch(`${API_URL}/comments?post=${POST}`);
    const data = await res.json();
    commentsEl.innerHTML = data
      .map(
        (c) => `
      <div>
        <div>${DOMPurify.sanitize(c.name) || 'Anonymous'}</div>
        <div>${render(c.msg)}</div>
      </div>
    `,
      )
      .join('');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await fetch(`${API_URL}/comments?post=${POST}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: form.name.value,
        // email: form.email.value,
        msg: form.message.value,
      }),
    });
    form.reset();
    preview.textContent = '';
    loadComments();
  });

  loadComments();
</script>
